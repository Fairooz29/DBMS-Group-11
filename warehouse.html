<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warehouse Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>
  <div class="sidebar">
    <h2>AGRITruck</h2>
    <ul>
      <li>Home</li>
      <li class="active">Warehouse</li>
      <li>Analysis</li>
      <li></li>
      <li>Storage</li>
    </ul>
  </div>

  <div class="main-content">
    <div class="top-cards">
      <div class="card">Sales: <strong id="sales-count">0</strong></div>
      <div class="card">Stock: <strong id="stock-count">0</strong></div>
      <div class="card">Inbound: <strong id="inbound-count">0</strong></div>
    </div>

    <div class="tabs" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
      <div>
        <button onclick="openModal('logistics')">Add Logistics</button>
        <button onclick="openModal('inventory')">Add Inventory</button>
        <button onclick="openModal('storage')">Add Storage</button>
      </div>
      <input type="text" id="searchInput" placeholder="Search table..." onkeyup="searchTable()" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc; max-width: 200px;">
    </div>

    <h2>Real-time supply Data</h2>

    <table>
      <thead>
        <tr>
          <th>Stage</th>
          <th>Product ID</th>
          <th>Product Name</th>
          <th>Humidity</th>
          <th>Date</th>
          <th>Quantity</th>
          <th>Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="data-table">
        <!-- Data rows will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modal-title">Add Data</h3>
      <div id="form-fields"></div>
      <button id="save-btn" onclick="saveEntry()">Save</button>
      <button id="update-btn" style="display:none;" onclick="updateEntry()">Update</button>
    </div>
  </div>

  <script>
    let currentType = '';
    let editRowRef = null;

    function openModal(type, row = null) {
      currentType = type;
      editRowRef = row;
      document.getElementById('modal-title').innerText = `${row ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      document.getElementById('modal').style.display = 'flex';
      renderFormFields(type, row);
      document.getElementById('save-btn').style.display = row ? 'none' : 'inline-block';
      document.getElementById('update-btn').style.display = row ? 'inline-block' : 'none';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      editRowRef = null;
    }

    function renderFormFields(type, row = null) {
      const container = document.getElementById('form-fields');
      let values = row ? [...row.children].map(cell => cell.textContent) : [];
      let html = '';

      if (type === 'logistics') {
        html = `
          <input type="text" id="product-id" placeholder="Product ID" value="${values[1] || ''}">
          <input type="text" id="name" placeholder="Product Name" value="${values[2] || ''}">
          <input type="text" id="humidity" placeholder="Humidity" value="${values[3] || ''}">
          <input type="date" id="date" value="${values[4] || ''}">
          <input type="number" id="qty" placeholder="Quantity" value="${values[5] || ''}">
          <input type="text" id="details" placeholder="Other Details" value="${values[6] || ''}">
        `;
      } else if (type === 'inventory') {
        html = `
          <input type="text" id="name" placeholder="Product Name" value="${values[2] || ''}">
          <input type="text" id="details" placeholder="Warehouse ID" value="${values[6] || ''}">
          <input type="number" id="qty" placeholder="Storage Quantity" value="${values[5] || ''}">
          <input type="date" id="date" value="${values[4] || ''}">
        `;
      } else if (type === 'storage') {
        html = `
          <input type="text" id="details" placeholder="Location" value="${values[6] || ''}">
          <input type="number" id="qty" placeholder="Capacity" value="${values[5] || ''}">
          <input type="date" id="date" value="${values[4] || ''}">
          <select id="name">
            <option value="Cold Storage">Cold Storage</option>
            <option value="Dry Storage">Dry Storage</option>
          </select>
        `;
      }
      container.innerHTML = html;
    }

    function saveEntry() {
  const stage = currentType;
  const productId = document.getElementById('product-id')?.value || '-';
  const name = document.getElementById('name').value;
  const humidity = document.getElementById('humidity')?.value || '-';
  const date = document.getElementById('date').value;
  const qty = document.getElementById('qty')?.value || '-';
  const details = document.getElementById('details')?.value || '-';

  const formData = new FormData();
  formData.append('stage', stage);
  formData.append('product_id', productId);
  formData.append('name', name);
  formData.append('humidity', humidity);
  formData.append('date', date);
  formData.append('qty', qty);
  formData.append('details', details);

  fetch('save_data.php', {
    method: 'POST',
    body: formData
  }).then(response => response.text())
    .then(data => {
      if (data.trim() === "success") {
        alert("Data saved successfully!");
        location.reload();
      } else {
        alert("Error saving data: " + data);
      }
    });
}


function updateEntry() {
  const id = editRowRef.dataset.id; // must be set when loading table rows
  const stage = currentType;
  const productId = document.getElementById('product-id')?.value || '-';
  const name = document.getElementById('name').value;
  const humidity = document.getElementById('humidity')?.value || '-';
  const date = document.getElementById('date').value;
  const qty = document.getElementById('qty')?.value || '-';
  const details = document.getElementById('details')?.value || '-';

  const formData = new FormData();
  formData.append('id', id);
  formData.append('stage', stage);
  formData.append('product_id', productId);
  formData.append('name', name);
  formData.append('humidity', humidity);
  formData.append('date', date);
  formData.append('qty', qty);
  formData.append('details', details);

  fetch('update_data.php', {
    method: 'POST',
    body: formData
  }).then(res => res.text())
    .then(data => {
      if (data.trim() === 'success') {
        alert('Data updated successfully!');
        location.reload();
      } else {
        alert('Update failed: ' + data);
      }
    });

  closeModal();
}


    function editEntry(btn) {
      const row = btn.closest('tr');
      const type = row.children[0].textContent;
      openModal(type, row);
    }

    function deleteEntry(btn) {
  if (confirm("Are you sure you want to delete this entry?")) {
    const row = btn.closest('tr');
    const id = row.dataset.id;

    const formData = new FormData();
    formData.append('id', id);

    fetch('delete_data.php', {
      method: 'POST',
      body: formData
    }).then(res => res.text())
      .then(data => {
        if (data.trim() === 'success') {
          alert('Entry deleted!');
          location.reload();
        } else {
          alert('Delete failed: ' + data);
        }
      });
  }
}


    function searchTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#data-table tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    document.addEventListener("DOMContentLoaded", loadTableData);

function loadTableData() {
  fetch('load_data.php')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = '';

      data.forEach(item => {
        const row = document.createElement('tr');
        row.setAttribute('data-id', item.id);
        row.innerHTML = `
          <td>${item.stage}</td>
          <td>${item.product_id}</td>
          <td>${item.product_name}</td>
          <td>${item.humidity}</td>
          <td>${item.date}</td>
          <td>${item.quantity}</td>
          <td>${item.details}</td>
          <td>
            <button onclick="editEntry(this)">Edit</button>
            <button onclick="deleteEntry(this)">Delete</button>
          </td>`;
        tbody.appendChild(row);
      });
    });
}

  </script>
</body>
</html>
